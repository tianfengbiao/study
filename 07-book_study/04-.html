<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    
</body>
</html>
<script>
class Promise {

    constructor(fn) {
        this.value = null
        this.state = 'pending'
        this.callbacks = []
        fn(this._resolve.bind(this), this._reject.bind(this))
    }

    _resolve(val) {
        this.state = 'fulfiled'
        this.value = val
        // this.callbacks.forEach(f => f(val))
        this.callbacks.forEach(info => this.handle(info))
    }

   

    then(onFulled) {
        // if(this.state === 'pending') {
        //     this.callbacks.push(onFulled)
        // } else {
        //     onFulled(this.value)
        // }
        // return this
        return new Promise(resolve => {
            this.handle({
                resolve: resolve,
                onFulled: onFulled || null
            })
        })
    }

    handle(handleInfo) {
        if (this.state === 'pending') {
            this.callbacks.push(handleInfo);
            return;
        }

        //如果then中没有传递任何东西
        if (!handleInfo.onFulled) {
            handleInfo.resolve(this.value);
            return;
        }
        
        var ret = handleInfo.onFulled(this.value);
        handleInfo.resolve(ret);
        // let onFulled = handleInfo.onFulled;
        // if(this.state === 'pending') {
        //     this.callbacks.push(onFulled)
        // } else {
        //     onFulled(this.value)
        // }
    }


    _reject(err) {
        this.state = 'rejected'
        this.value = err
        // this.callbacks.forEach(f => f(val))
    }

    // catch(onReject) {
    //     if(this.state === 'pending') {
    //         this.callbacks.push(onFulled)
    //     } else {
    //         onFulled(this.value)
    //     }
        
    //     return this
    // }
}

getUserId('some_url').then(function (id) {
    //do something
    console.log('id===',id)
    return getNameById(id);
}).then(function (name) {
    //do something
    console.log('name===',name)

    return getCourseByName(name);
}).then(function (course) {
    //do something
    console.log('course===',course)
    
    return getCourseDetailByCourse(course);
}).then(function (courseDetail) {
    //do something
    console.log('courseDetail===',courseDetail)

    console.log('end promise')
});

function getUserId(url) {
    return new Promise(function (resolve) {
        //异步请求
        setTimeout(()=> {
            resolve('学号111')
        },100)
    })
}
function getNameById(id) {
    return new Promise(function (resolve) {
        //异步请求
        setTimeout(()=> {
            resolve('姓名钟少丹')
        },100)
    })
}
function getCourseByName() {
    return new Promise(function (resolve) {
        //异步请求
        setTimeout(()=> {
            resolve('课程会计')
        },100)
    })
}
function getCourseDetailByCourse() {
    return new Promise(function (resolve) {
        //异步请求
        setTimeout(()=> {
            resolve('会计详细信息')
        },100)
    })
}

// let p = new Promise(resolve => {
//     // setTimeout(() => {
//     //     console.log('done');
//     //     resolve('5秒');
//     // }, 5000);
//     console.log('同步执行');
//     resolve('同步执行');
// }).then(tip => {
//     console.log('then1', tip);
// }).then(tip => {
//     console.log('then2', tip);
// });

// setTimeout(() => {
//     p.then(tip => {
//         console.log('then3', tip);
//     })
// });

</script>